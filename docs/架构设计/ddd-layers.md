# DDD åˆ†å±‚æ¶æ„è®¾è®¡ (åŸºäº COLA æ¶æ„)

> å‚è€ƒæ¶æ„ï¼š
>
> - é˜¿é‡Œå·´å·´ COLA (Clean Object-Oriented and Layered Architecture) v5
> - é˜¿é‡ŒæŠ€æœ¯ä¸“å®¶ DDD ç³»åˆ—
> - å…­è¾¹å½¢æ¶æ„ (Hexagonal Architecture)
>
> è®¾è®¡æ—¥æœŸï¼š2025-12-08
> ç‰ˆæœ¬ï¼šv5.0 (COLA é£æ ¼)

---

## 1. DDD å››å±‚æ¶æ„

```
ğŸ“¦ Adapter Layer (é€‚é…å™¨å±‚)
â”œâ”€â”€ Web Adapter (REST API - FastAPI)
â”œâ”€â”€ CLI Adapter (Typer)
â”œâ”€â”€ PythonSdk
â”‚
â”œâ”€â”€ èŒè´£ï¼šé€‚é…ä¸åŒçš„è®¿é—®æ–¹å¼ï¼Œå°†å¤–éƒ¨è¯·æ±‚è½¬æ¢ä¸ºåº”ç”¨æœåŠ¡è°ƒç”¨
â””â”€â”€ ç‰¹ç‚¹ï¼šè–„è–„ä¸€å±‚ï¼Œåªåšé€‚é…å’Œæ ¼å¼è½¬æ¢

    â†“

ğŸ“¦ Client Layer (å®¢æˆ·ç«¯å±‚) - COLA å¯é€‰
â”œâ”€â”€ DTO å®šä¹‰
â”‚   â”œâ”€â”€ Request DTO
â”‚   â”œâ”€â”€ Response DTO
â”‚   â”œâ”€â”€ Command DTO
â”‚   â””â”€â”€ Query DTO
â”œâ”€â”€ API æ¥å£å®šä¹‰
â”œâ”€â”€ é”™è¯¯ç å®šä¹‰
â”‚
â”œâ”€â”€ èŒè´£ï¼šå®šä¹‰å¯¹å¤– API å¥‘çº¦ï¼Œå¯ä»¥ç‹¬ç«‹å‘å¸ƒç»™è°ƒç”¨æ–¹
â””â”€â”€ ç‰¹ç‚¹ï¼šå¯ä»¥è¢«å…¶ä»–æœåŠ¡ä¾èµ–ï¼ŒåªåŒ…å«æ¥å£å’Œ DTOï¼Œæ— å®ç°

    â†“

ğŸ“¦ Application Layer (åº”ç”¨å±‚)
â”œâ”€â”€ Application Services (åº”ç”¨æœåŠ¡)
â”‚   â”œâ”€â”€ PipelineApplicationService
â”‚   â”œâ”€â”€ ExecutionApplicationService
â”‚   â”œâ”€â”€ TaskApplicationService
â”‚   â””â”€â”€ MonitoringApplicationService
â”œâ”€â”€ DTO Assembler (DTO ç»„è£…å™¨)
â”œâ”€â”€ Event Subscribers (äº‹ä»¶è®¢é˜…è€…)
â”‚
â”œâ”€â”€ èŒè´£ï¼šç”¨ä¾‹ç¼–æ’ã€äº‹åŠ¡æ§åˆ¶ã€æƒé™æ§åˆ¶ã€DTOè½¬æ¢
â””â”€â”€ ç‰¹ç‚¹ï¼šè–„è–„ä¸€å±‚ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œåªåšç¼–æ’

    â†“

ğŸ“¦ Domain Layer (é¢†åŸŸå±‚) â­ æ ¸å¿ƒ
â”‚
â”œâ”€â”€ ğŸ“‚ Aggregates (èšåˆæ ¹) + Entities (å®ä½“)
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“¦ PipelineExecution (æµæ°´çº¿æ‰§è¡Œ) - Aggregate Root â­ æ ¸å¿ƒ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ã€æ ¸å¿ƒçŠ¶æ€ã€‘â­ å‚è€ƒ Dify GraphRuntimeState
â”‚   â”‚   â”‚   â”œâ”€â”€ executionId: ExecutionId
â”‚   â”‚   â”‚   â”œâ”€â”€ pipelineId: PipelineId
â”‚   â”‚   â”‚   â”œâ”€â”€ status: ExecutionStatus
â”‚   â”‚   â”‚   â”œâ”€â”€ variablePool: VariablePool (é¢†åŸŸæœåŠ¡å¼•ç”¨)
â”‚   â”‚   â”‚   â”œâ”€â”€ eventHistory: List<Event> (äº‹ä»¶å†å²è®°å½•)
â”‚   â”‚   â”‚   â”œâ”€â”€ nodeExecutions: Map<NodeId, NodeExecution>
â”‚   â”‚   â”‚   â”œâ”€â”€ startAt: DateTime
â”‚   â”‚   â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šæ‰€æœ‰èŠ‚ç‚¹å…±äº«åŒä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ã€å®ä½“ã€‘
â”‚   â”‚   â”‚   â””â”€â”€ NodeExecution (èŠ‚ç‚¹æ‰§è¡Œ) - Entity
â”‚   â”‚   â”‚       â”œâ”€â”€ nodeId: NodeId
â”‚   â”‚   â”‚       â”œâ”€â”€ status: NodeStatus
â”‚   â”‚   â”‚       â”œâ”€â”€ inputs: Map<String, Object>
â”‚   â”‚   â”‚       â”œâ”€â”€ outputs: Map<String, Object>
â”‚   â”‚   â”‚       â””â”€â”€ ç‰¹ç‚¹ï¼šèŠ‚ç‚¹çº§åˆ«çš„æ‰§è¡ŒçŠ¶æ€
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ã€ä¸šåŠ¡æ–¹æ³•ã€‘
â”‚   â”‚   â”‚   â”œâ”€â”€ executeNode(nodeId) - æ‰§è¡ŒèŠ‚ç‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ publishEvent(event) - å‘å¸ƒäº‹ä»¶ï¼ˆè®°å½•åˆ° eventHistoryï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ subscribeToEvent(pattern, handler) - è®¢é˜…äº‹ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ getVariable(selector) - è·å–å˜é‡
â”‚   â”‚   â”‚   â”œâ”€â”€ setVariable(selector, value) - è®¾ç½®å˜é‡
â”‚   â”‚   â”‚   â”œâ”€â”€ pauseExecution() - æš‚åœæ‰§è¡Œ
â”‚   â”‚   â”‚   â”œâ”€â”€ resumeExecution() - æ¢å¤æ‰§è¡Œ
â”‚   â”‚   â”‚   â””â”€â”€ markComplete() - æ ‡è®°å®Œæˆ
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šåŒ…å«å˜é‡æ± å’Œäº‹ä»¶å†å²ï¼Œæ˜¯æ‰§è¡Œçš„å®Œæ•´ä¸Šä¸‹æ–‡
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“¦ PipelineDefinition (æµæ°´çº¿å®šä¹‰) - Aggregate Root
â”‚   â”‚   â”œâ”€â”€ NodeDefinition (èŠ‚ç‚¹å®šä¹‰) - Entity
â”‚   â”‚   â”œâ”€â”€ validateDefinition() - ä¸šåŠ¡æ–¹æ³•
â”‚   â”‚   â””â”€â”€ publish() - ä¸šåŠ¡æ–¹æ³•
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“¦ TaskDefinition (ä»»åŠ¡å®šä¹‰) - Aggregate Root
â”‚   â”‚   â”œâ”€â”€ VariableDefinition (å˜é‡å®šä¹‰) - Value Object
â”‚   â”‚   â”œâ”€â”€ validate() - ä¸šåŠ¡æ–¹æ³•
â”‚   â”‚   â””â”€â”€ publish() - ä¸šåŠ¡æ–¹æ³•
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“¦ TaskExecution (ä»»åŠ¡æ‰§è¡Œ) - Aggregate Root
â”‚       â”œâ”€â”€ start() - ä¸šåŠ¡æ–¹æ³•
â”‚       â”œâ”€â”€ complete() - ä¸šåŠ¡æ–¹æ³•
â”‚       â””â”€â”€ fail() - ä¸šåŠ¡æ–¹æ³•
â”‚
â”œâ”€â”€ ğŸ“‚ Value Objects (å€¼å¯¹è±¡) - Domain Primitives
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€èº«ä»½æ ‡è¯†ã€‘
â”‚   â”‚   â”œâ”€â”€ ExecutionId - æ‰§è¡ŒID
â”‚   â”‚   â”œâ”€â”€ PipelineId - æµæ°´çº¿ID
â”‚   â”‚   â”œâ”€â”€ NodeId - èŠ‚ç‚¹ID
â”‚   â”‚   â””â”€â”€ TaskId - ä»»åŠ¡ID
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€å˜é‡ç›¸å…³ã€‘â­ å‚è€ƒ Dify
â”‚   â”‚   â”œâ”€â”€ Variable - å˜é‡å€¼å¯¹è±¡
â”‚   â”‚   â”‚   â”œâ”€â”€ id: VariableId
â”‚   â”‚   â”‚   â”œâ”€â”€ name: String
â”‚   â”‚   â”‚   â”œâ”€â”€ type: VariableType (STRING, INTEGER, FLOAT, OBJECT, ARRAY, FILE)
â”‚   â”‚   â”‚   â”œâ”€â”€ value: Object
â”‚   â”‚   â”‚   â”œâ”€â”€ selector: List[String] (å¦‚ [nodeId, variableName])
â”‚   â”‚   â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šç±»å‹å®‰å…¨ã€ä¸å¯å˜
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ VariableSelector - å˜é‡é€‰æ‹©å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ path: List[String] (å¦‚ ["node1", "output", "result"])
â”‚   â”‚   â”‚   â”œâ”€â”€ toKey() - è½¬æ¢ä¸ºé”®
â”‚   â”‚   â”‚   â””â”€â”€ æ”¯æŒåµŒå¥—å±æ€§è®¿é—®
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ VariableReference - å˜é‡å¼•ç”¨
â”‚   â”‚   â”‚   â”œâ”€â”€ expression: String (å¦‚ "{{#node1.output#}}")
â”‚   â”‚   â”‚   â””â”€â”€ resolve(pool: VariablePool) - è§£æä¸ºå®é™…å€¼
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ VariableType - å˜é‡ç±»å‹æšä¸¾
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€äº‹ä»¶ç›¸å…³ã€‘â­ å‚è€ƒ Dify
â”‚   â”‚   â”œâ”€â”€ Event - äº‹ä»¶å€¼å¯¹è±¡ï¼ˆä½œä¸ºé¢†åŸŸæ¦‚å¿µï¼ŒéåŸºç¡€è®¾æ–½ï¼ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ eventId: EventId
â”‚   â”‚   â”‚   â”œâ”€â”€ eventType: String
â”‚   â”‚   â”‚   â”œâ”€â”€ source: NodeId
â”‚   â”‚   â”‚   â”œâ”€â”€ timestamp: DateTime
â”‚   â”‚   â”‚   â”œâ”€â”€ payload: Map<String, Object>
â”‚   â”‚   â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šä¸å¯å˜ã€å®Œæ•´è®°å½•äº‹ä»¶ä¿¡æ¯
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ EventPattern - äº‹ä»¶æ¨¡å¼
â”‚   â”‚   â”‚   â”œâ”€â”€ pattern: String (æ”¯æŒé€šé…ç¬¦ï¼Œå¦‚ "node.*.completed")
â”‚   â”‚   â”‚   â”œâ”€â”€ matches(event: Event) - åˆ¤æ–­äº‹ä»¶æ˜¯å¦åŒ¹é…
â”‚   â”‚   â”‚   â””â”€â”€ ç”¨äº startWhen/stopWhen æ¡ä»¶
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ TriggerCondition - è§¦å‘æ¡ä»¶
â”‚   â”‚       â”œâ”€â”€ eventPattern: EventPattern
â”‚   â”‚       â”œâ”€â”€ expression: String (å¯é€‰çš„é¢å¤–æ¡ä»¶è¡¨è¾¾å¼)
â”‚   â”‚       â””â”€â”€ evaluate(event: Event, context) - è¯„ä¼°æ˜¯å¦è§¦å‘
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€çŠ¶æ€ç›¸å…³ã€‘
â”‚   â”‚   â”œâ”€â”€ ExecutionStatus - æ‰§è¡ŒçŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ NodeStatus - èŠ‚ç‚¹çŠ¶æ€
â”‚   â”‚   â””â”€â”€ TaskStatus - ä»»åŠ¡çŠ¶æ€
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€å…¶ä»–ã€‘
â”‚   â”‚   â”œâ”€â”€ TaskType - ä»»åŠ¡ç±»å‹
â”‚   â”‚   â””â”€â”€ VariablePath - å˜é‡è·¯å¾„
â”‚   â”‚
â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šä¸å¯å˜ã€è‡ªéªŒè¯ã€æœ‰ä¸šåŠ¡å«ä¹‰ã€å°è£…é¢†åŸŸè§„åˆ™
â”‚
â”œâ”€â”€ ğŸ“‚ Domain Services (é¢†åŸŸæœåŠ¡)
â”‚   â”œâ”€â”€ ExecutionOrchestrator (æ‰§è¡Œç¼–æ’å™¨) â­ æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ èŒè´£ï¼šåè°ƒèŠ‚ç‚¹æ‰§è¡Œæµç¨‹ï¼Œç®¡ç†æ‰§è¡ŒçŠ¶æ€è½¬æ¢
â”‚   â”‚   â”œâ”€â”€ executeNode() - æ‰§è¡Œå•ä¸ªèŠ‚ç‚¹
â”‚   â”‚   â”œâ”€â”€ getReadyNodes() - è·å–å°±ç»ªèŠ‚ç‚¹åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ handleNodeCompletion() - å¤„ç†èŠ‚ç‚¹å®Œæˆ
â”‚   â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šåŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆè§¦å‘è¯„ä¼°ã€æ‰§è¡Œæ§åˆ¶ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ VariablePool (å˜é‡æ± ) â­ æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ èŒè´£ï¼šç®¡ç†æ‰§è¡ŒæœŸé—´çš„æ‰€æœ‰å˜é‡ï¼Œæä¾›ç»Ÿä¸€è®¿é—®æ¥å£
â”‚   â”‚   â”œâ”€â”€ get(selector: List[str]) - é€šè¿‡é€‰æ‹©å™¨è·å–å˜é‡
â”‚   â”‚   â”œâ”€â”€ add(selector: List[str], value) - æ·»åŠ /æ›´æ–°å˜é‡
â”‚   â”‚   â”œâ”€â”€ remove(selector: List[str]) - ç§»é™¤å˜é‡
â”‚   â”‚   â”œâ”€â”€ getByPrefix(nodeIdPrefix: str) - æŒ‰èŠ‚ç‚¹å‰ç¼€è·å–
â”‚   â”‚   â”œâ”€â”€ æ•°æ®ç»“æ„ï¼šMap<nodeId, Map<variableName, Variable>>
â”‚   â”‚   â”œâ”€â”€ æ”¯æŒåµŒå¥—è®¿é—®ï¼š[nodeId, varName, attr1, attr2, ...]
â”‚   â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šç±»å‹å®‰å…¨ã€ç»Ÿä¸€æ¥å£ã€æ”¯æŒåªè¯»è§†å›¾
â”‚   â”‚
â”‚   â”œâ”€â”€ EventSubscriptionManager (äº‹ä»¶è®¢é˜…ç®¡ç†å™¨) â­ æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ èŒè´£ï¼šç®¡ç†äº‹ä»¶è®¢é˜…å…³ç³»ï¼ŒåŒ¹é…äº‹ä»¶è§¦å‘æ¡ä»¶
â”‚   â”‚   â”œâ”€â”€ subscribe(eventPattern, handler) - æ³¨å†Œè®¢é˜…
â”‚   â”‚   â”œâ”€â”€ unsubscribe(eventPattern, handler) - å–æ¶ˆè®¢é˜…
â”‚   â”‚   â”œâ”€â”€ getMatchingHandlers(event) - è·å–åŒ¹é…çš„å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ evaluateTrigger(event, condition) - è¯„ä¼°è§¦å‘æ¡ä»¶
â”‚   â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šæ”¯æŒæ¨¡å¼åŒ¹é…ã€æ¡ä»¶è¯„ä¼°
â”‚   â”‚
â”‚   â”œâ”€â”€ DependencyResolutionService (ä¾èµ–è§£ææœåŠ¡)
â”‚   â”‚   â”œâ”€â”€ è§£æ startWhen/stopWhen è¡¨è¾¾å¼
â”‚   â”‚   â””â”€â”€ æŸ¥è¯¢å“ªäº›èŠ‚ç‚¹è¢«äº‹ä»¶è§¦å‘
â”‚   â”‚
â”‚   â”œâ”€â”€ VariableResolutionService (å˜é‡è§£ææœåŠ¡)
â”‚   â”‚   â”œâ”€â”€ è§£æå˜é‡å¼•ç”¨ï¼ˆæ”¯æŒç‚¹å·è·¯å¾„ï¼šnode1.output.resultï¼‰
â”‚   â”‚   â”œâ”€â”€ è§£æè¡¨è¾¾å¼ï¼ˆæ”¯æŒæ¨¡æ¿ï¼š{{#node1.output#}}ï¼‰
â”‚   â”‚   â””â”€â”€ ç±»å‹è½¬æ¢å’ŒéªŒè¯
â”‚   â”‚
â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šæ— çŠ¶æ€æœåŠ¡ã€è·¨èšåˆæ ¹åè°ƒã€åŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚
â”œâ”€â”€ ğŸ“‚ Gateway (ç½‘å…³/é˜²è…å±‚) - COLA æ ¸å¿ƒæ¦‚å¿µ â­
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€æŒä¹…åŒ–ç½‘å…³ã€‘
â”‚   â”‚   â”œâ”€â”€ PipelineDefinitionGateway (æµæ°´çº¿å®šä¹‰ç½‘å…³)
â”‚   â”‚   â”œâ”€â”€ PipelineExecutionGateway (æµæ°´çº¿æ‰§è¡Œç½‘å…³)
â”‚   â”‚   â”œâ”€â”€ TaskDefinitionGateway (ä»»åŠ¡å®šä¹‰ç½‘å…³)
â”‚   â”‚   â””â”€â”€ TaskExecutionGateway (ä»»åŠ¡æ‰§è¡Œç½‘å…³)
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€å˜é‡ä¸äº‹ä»¶ç½‘å…³ã€‘â­ å‚è€ƒ Dify
â”‚   â”‚   â”œâ”€â”€ VariableStorageGateway (å˜é‡å­˜å‚¨ç½‘å…³)
â”‚   â”‚   â”‚   â”œâ”€â”€ saveVariables(executionId, variablePool)
â”‚   â”‚   â”‚   â”œâ”€â”€ loadVariables(executionId) -> VariablePool
â”‚   â”‚   â”‚   â””â”€â”€ å®ç°æ–¹å¼ï¼šRedisã€PostgreSQLã€å†…å­˜
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ EventPublishGateway (äº‹ä»¶å‘å¸ƒç½‘å…³)
â”‚   â”‚   â”‚   â”œâ”€â”€ publish(event: DomainEvent)
â”‚   â”‚   â”‚   â”œâ”€â”€ subscribe(eventType, consumer)
â”‚   â”‚   â”‚   â””â”€â”€ å®ç°æ–¹å¼ï¼šKafkaã€RabbitMQã€å†…å­˜é˜Ÿåˆ—
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ EventStoreGateway (äº‹ä»¶å­˜å‚¨ç½‘å…³)
â”‚   â”‚       â”œâ”€â”€ append(executionId, event)
â”‚   â”‚       â”œâ”€â”€ queryEvents(executionId, eventType)
â”‚   â”‚       â””â”€â”€ å®ç°æ–¹å¼ï¼šEventStoreã€PostgreSQL
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€å¤–éƒ¨ç³»ç»Ÿç½‘å…³ã€‘
â”‚   â”‚   â”œâ”€â”€ ExecutorGateway (å¤–éƒ¨æ‰§è¡Œå™¨ç½‘å…³)
â”‚   â”‚   â”‚   â””â”€â”€ è°ƒç”¨ Spark/Airflow/K8s
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ NotificationGateway (é€šçŸ¥ç½‘å…³)
â”‚   â”‚       â””â”€â”€ é‚®ä»¶/é’‰é’‰/Slack
â”‚   â”‚
â”‚   â”œâ”€â”€ ç‰¹ç‚¹ï¼šæ¥å£å®šä¹‰åœ¨é¢†åŸŸå±‚ï¼Œå®ç°åœ¨åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ ä½œç”¨ï¼šé˜²è…å±‚ï¼Œéš”ç¦»å¤–éƒ¨ç³»ç»Ÿï¼Œä¿æŠ¤é¢†åŸŸæ¨¡å‹çº¯å‡€
â”‚   â””â”€â”€ åŸåˆ™ï¼šé¢†åŸŸå±‚åªä¾èµ– Gateway æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
â”‚
â”œâ”€â”€ ğŸ“‚ Repository Interfaces (ä»“å‚¨æ¥å£)
â”‚   â”œâ”€â”€ PipelineDefinitionRepository
â”‚   â”œâ”€â”€ PipelineExecutionRepository
â”‚   â”œâ”€â”€ TaskExecutionRepository
â”‚   â”œâ”€â”€ EventRepository
â”‚   â”œâ”€â”€ VariableRepository
â”‚   â”‚
â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šåªå®šä¹‰æ¥å£ï¼Œä¸å®ç°
â”‚
â”œâ”€â”€ ğŸ“‚ Domain Events (é¢†åŸŸäº‹ä»¶) â­ å‚è€ƒ Dify äº‹ä»¶é©±åŠ¨æ¶æ„
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€äº‹ä»¶å±‚æ¬¡ç»“æ„ã€‘
â”‚   â”‚   â”œâ”€â”€ GraphEngineEvent (åŸºç±»)
â”‚   â”‚   â”œâ”€â”€ GraphEvent (å›¾çº§åˆ«äº‹ä»¶)
â”‚   â”‚   â””â”€â”€ NodeEvent (èŠ‚ç‚¹çº§åˆ«äº‹ä»¶)
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€Pipeline çº§åˆ«äº‹ä»¶ã€‘
â”‚   â”‚   â”œâ”€â”€ PipelineStartedEvent - æµæ°´çº¿å¯åŠ¨
â”‚   â”‚   â”œâ”€â”€ PipelineCompletedEvent - æµæ°´çº¿å®Œæˆ
â”‚   â”‚   â”œâ”€â”€ PipelineFailedEvent - æµæ°´çº¿å¤±è´¥
â”‚   â”‚   â””â”€â”€ PipelinePausedEvent - æµæ°´çº¿æš‚åœ
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€Node çº§åˆ«äº‹ä»¶ã€‘
â”‚   â”‚   â”œâ”€â”€ NodeRunStartedEvent - èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œ
â”‚   â”‚   â”‚   â”œâ”€â”€ nodeId: NodeId
â”‚   â”‚   â”‚   â”œâ”€â”€ nodeTitle: String
â”‚   â”‚   â”‚   â”œâ”€â”€ startAt: DateTime
â”‚   â”‚   â”‚   â””â”€â”€ predecessorNodeId: NodeId (å¯é€‰)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ NodeRunSucceededEvent - èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ â­ å…³é”®
â”‚   â”‚   â”‚   â”œâ”€â”€ nodeId: NodeId
â”‚   â”‚   â”‚   â”œâ”€â”€ outputs: Map<String, Object>
â”‚   â”‚   â”‚   â”œâ”€â”€ metadata: Map<String, Object>
â”‚   â”‚   â”‚   â””â”€â”€ è§¦å‘ï¼šæ›´æ–°å˜é‡æ±  + å¤„ç†è¾¹è¿æ¥ + å…¥é˜Ÿå°±ç»ªèŠ‚ç‚¹
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ NodeRunFailedEvent - èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥
â”‚   â”‚   â”‚   â”œâ”€â”€ nodeId: NodeId
â”‚   â”‚   â”‚   â”œâ”€â”€ error: String
â”‚   â”‚   â”‚   â””â”€â”€ è§¦å‘ï¼šè®°å½•é”™è¯¯ + æ‰§è¡Œå¤±è´¥å¤„ç†
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ NodeRunStreamChunkEvent - èŠ‚ç‚¹æµå¼è¾“å‡º
â”‚   â”‚   â”‚   â”œâ”€â”€ nodeId: NodeId
â”‚   â”‚   â”‚   â”œâ”€â”€ selector: List[String]
â”‚   â”‚   â”‚   â”œâ”€â”€ chunk: String
â”‚   â”‚   â”‚   â””â”€â”€ isFinal: Boolean
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ NodeRunRetryEvent - èŠ‚ç‚¹é‡è¯•
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€Task çº§åˆ«äº‹ä»¶ã€‘
â”‚   â”‚   â”œâ”€â”€ TaskStartedEvent
â”‚   â”‚   â”œâ”€â”€ TaskCompletedEvent
â”‚   â”‚   â””â”€â”€ TaskFailedEvent
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€ç‰¹æ®Šå®¹å™¨èŠ‚ç‚¹äº‹ä»¶ã€‘
â”‚   â”‚   â”œâ”€â”€ IterationStartedEvent - è¿­ä»£å¼€å§‹
â”‚   â”‚   â”œâ”€â”€ IterationNextEvent - è¿­ä»£ä¸‹ä¸€ä¸ª
â”‚   â”‚   â”œâ”€â”€ LoopStartedEvent - å¾ªç¯å¼€å§‹
â”‚   â”‚   â””â”€â”€ LoopNextEvent - å¾ªç¯ä¸‹ä¸€ä¸ª
â”‚   â”‚
â”‚   â””â”€â”€ ã€äº‹ä»¶å¤„ç†æœºåˆ¶ã€‘â­ æ ¸å¿ƒ
â”‚       â”œâ”€â”€ EventHandler (äº‹ä»¶å¤„ç†å™¨) - ä½¿ç”¨å•åˆ†æ´¾æ¨¡å¼
â”‚       â”œâ”€â”€ EventQueue (äº‹ä»¶é˜Ÿåˆ—) - å¼‚æ­¥äº‹ä»¶å¤„ç†
â”‚       â”œâ”€â”€ EventCollector (äº‹ä»¶æ”¶é›†å™¨) - æ”¶é›†å’Œæµå¼è¾“å‡º
â”‚       â””â”€â”€ æµç¨‹ï¼šèŠ‚ç‚¹æ‰§è¡Œ â†’ å‘å‡ºäº‹ä»¶ â†’ EventHandlerå¤„ç† â†’ æ›´æ–°çŠ¶æ€ â†’ è§¦å‘ä¸‹ä¸€èŠ‚ç‚¹
â”‚
â”œâ”€â”€ èŒè´£ï¼šä¸šåŠ¡é€»è¾‘çš„æ ¸å¿ƒï¼ŒåŒ…å«èšåˆæ ¹ã€å®ä½“ã€å€¼å¯¹è±¡ã€é¢†åŸŸæœåŠ¡
â”œâ”€â”€ ç‰¹ç‚¹ï¼šä¸ä¾èµ–å¤–éƒ¨æ¡†æ¶ï¼Œé¢†åŸŸå¯¹è±¡çº¯å‡€ï¼Œé€šè¿‡ Gateway ä¸å¤–éƒ¨äº¤äº’
â”‚
â””â”€â”€ ã€æ ¸å¿ƒè®¾è®¡åŸåˆ™ã€‘â­ å‚è€ƒ Dify æ¶æ„
    â”œâ”€â”€ 1. Variable å’Œ Event æ˜¯é¢†åŸŸæ¦‚å¿µï¼ˆä¸æ˜¯åŸºç¡€è®¾æ–½ï¼ï¼‰
    â”œâ”€â”€ 2. VariablePool ä½œä¸ºé¢†åŸŸæœåŠ¡ç®¡ç†å˜é‡ç”Ÿå‘½å‘¨æœŸ
    â”œâ”€â”€ 3. PipelineExecution èšåˆæ ¹æŒæœ‰ VariablePool å’Œ EventHistory
    â”œâ”€â”€ 4. äº‹ä»¶é©±åŠ¨æ‰§è¡Œæµï¼šèŠ‚ç‚¹æ‰§è¡Œ â†’ å‘äº‹ä»¶ â†’ å¤„ç† â†’ æ›´æ–°çŠ¶æ€ â†’ è§¦å‘ä¸‹ä¸€èŠ‚ç‚¹
    â”œâ”€â”€ 5. åªè¯»è§†å›¾ä¿æŠ¤æ•°æ®ï¼šå¯¹å¤–æš´éœ² ReadOnly æ¥å£
    â””â”€â”€ 6. Gateway åˆ†ç¦»å…³æ³¨ç‚¹ï¼šé¢†åŸŸå±‚å®šä¹‰æ¥å£ï¼ŒåŸºç¡€è®¾æ–½å±‚å®ç°

    â†“

ğŸ“¦ Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚) - COLA é£æ ¼ â­ å‚è€ƒ Dify
â”‚
â”œâ”€â”€ ğŸ“‚ Gateway Implementations (ç½‘å…³å®ç°) - å®ç°é¢†åŸŸå±‚çš„ Gateway
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€æŒä¹…åŒ–ç½‘å…³å®ç°ã€‘
â”‚   â”‚   â”œâ”€â”€ PipelineDefinitionGatewayImpl
â”‚   â”‚   â”œâ”€â”€ PipelineExecutionGatewayImpl
â”‚   â”‚   â”œâ”€â”€ TaskDefinitionGatewayImpl
â”‚   â”‚   â””â”€â”€ TaskExecutionGatewayImpl
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€å˜é‡ä¸äº‹ä»¶ç½‘å…³å®ç°ã€‘â­ å…³é”®
â”‚   â”‚   â”œâ”€â”€ RedisVariableStorageGateway
â”‚   â”‚   â”‚   â””â”€â”€ ä½¿ç”¨ Redis Hash å­˜å‚¨å˜é‡æ± 
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ PostgreSQLVariableStorageGateway
â”‚   â”‚   â”‚   â””â”€â”€ ä½¿ç”¨ JSONB åˆ—å­˜å‚¨å˜é‡æ± 
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ KafkaEventPublishGateway
â”‚   â”‚   â”‚   â””â”€â”€ å‘å¸ƒäº‹ä»¶åˆ° Kafka Topic
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ RabbitMQEventPublishGateway
â”‚   â”‚   â”‚   â””â”€â”€ å‘å¸ƒäº‹ä»¶åˆ° RabbitMQ Exchange
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ EventStoreGatewayImpl
â”‚   â”‚       â””â”€â”€ ä½¿ç”¨ EventStore æˆ– PostgreSQL æŒä¹…åŒ–äº‹ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ ã€å¤–éƒ¨ç³»ç»Ÿç½‘å…³å®ç°ã€‘
â”‚   â”‚   â”œâ”€â”€ ExecutorGatewayImpl (è°ƒç”¨ Spark/Airflow/K8s)
â”‚   â”‚   â””â”€â”€ NotificationGatewayImpl (é‚®ä»¶/é’‰é’‰/Slack)
â”‚   â”‚
â”‚   â””â”€â”€ ç‰¹ç‚¹ï¼šå¯éšæ—¶æ›¿æ¢å®ç°ï¼Œä¸å½±å“é¢†åŸŸå±‚
â”‚
â”œâ”€â”€ ğŸ“‚ Converters (è½¬æ¢å™¨) - DO â†” Domain Entity
â”‚   â”œâ”€â”€ PipelineExecutionConverter
â”‚   â””â”€â”€ TaskExecutionConverter
â”‚
â”œâ”€â”€ ğŸ“‚ Data Objects (DO) - æ•°æ®åº“æ˜ å°„å¯¹è±¡
â”‚   â”œâ”€â”€ PipelineExecutionDO
â”‚   â””â”€â”€ TaskExecutionDO
â”‚
â”œâ”€â”€ ğŸ“‚ Database (æ•°æ®åº“)
â”‚   â””â”€â”€ PostgreSQL + SQLAlchemy ORM
â”‚
â”œâ”€â”€ ğŸ“‚ External Systems (å¤–éƒ¨ç³»ç»Ÿ) â­ å‚è€ƒ Dify
â”‚   â”œâ”€â”€ Redis
â”‚   â”‚   â”œâ”€â”€ å˜é‡æ± å­˜å‚¨ï¼ˆVariablePool åºåˆ—åŒ–ï¼‰
â”‚   â”‚   â”œâ”€â”€ æ‰§è¡ŒçŠ¶æ€ç¼“å­˜
â”‚   â”‚   â””â”€â”€ å‘½ä»¤é€šé“ï¼ˆCommandChannelï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ Kafka/RabbitMQ
â”‚   â”‚   â”œâ”€â”€ äº‹ä»¶å‘å¸ƒä¸è®¢é˜…
â”‚   â”‚   â””â”€â”€ å¼‚æ­¥ä»»åŠ¡è§¦å‘
â”‚   â”‚
â”‚   â”œâ”€â”€ PostgreSQL/MySQL
â”‚   â”‚   â”œâ”€â”€ èšåˆæ ¹æŒä¹…åŒ–
â”‚   â”‚   â”œâ”€â”€ äº‹ä»¶å­˜å‚¨ï¼ˆEvent Sourcingï¼‰
â”‚   â”‚   â””â”€â”€ å˜é‡æ± æŒä¹…åŒ–ï¼ˆå¤‡ä»½ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ Celery/Temporal
â”‚   â”‚   â””â”€â”€ ä»»åŠ¡é˜Ÿåˆ—å’Œå·¥ä½œæµå¼•æ“
â”‚   â”‚
â”‚   â”œâ”€â”€ S3/MinIO
â”‚   â”‚   â””â”€â”€ å¯¹è±¡å­˜å‚¨ï¼ˆæ–‡ä»¶å˜é‡ã€å¤§å¯¹è±¡ï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ Spark/K8s/Airflow
â”‚       â””â”€â”€ æ‰§è¡Œå¼•æ“
â”‚
â”œâ”€â”€ ğŸ“‚ Framework Integration (æ¡†æ¶é›†æˆ)
â”‚   â”œâ”€â”€ Spring Boot / FastAPI
â”‚   â”œâ”€â”€ Dependency Injection
â”‚   â””â”€â”€ Logging, Monitoring, Tracing
â”‚
â”œâ”€â”€ èŒè´£ï¼šå®ç° Gateway æ¥å£ï¼Œéš”ç¦»æŠ€æœ¯ç»†èŠ‚ï¼Œä¸è®©æŠ€æœ¯å¤æ‚åº¦æ±¡æŸ“é¢†åŸŸå±‚
â”œâ”€â”€ ç‰¹ç‚¹ï¼šå¯éšæ—¶æ›¿æ¢å®ç°ï¼ˆå¦‚ä» PostgreSQL æ¢åˆ° MySQLï¼‰
â”‚
â””â”€â”€ ã€å®ç°ç¤ºä¾‹ã€‘â­ å‚è€ƒ Dify
    â”œâ”€â”€ WorkerPool - åŠ¨æ€æ‰©ç¼©å®¹çš„å·¥ä½œæ± 
    â”œâ”€â”€ EventQueue - å¼‚æ­¥äº‹ä»¶é˜Ÿåˆ—å¤„ç†
    â”œâ”€â”€ Dispatcher - äº‹ä»¶è°ƒåº¦å™¨ï¼ˆè¿è¡Œåœ¨ç‹¬ç«‹çº¿ç¨‹ï¼‰
    â””â”€â”€ ConnectionPool - è¿æ¥æ± ç®¡ç†ï¼ˆå¦‚ ClickZettaï¼‰
```

---

## 2. æ ¸å¿ƒæ¶æ„è®¾è®¡åŸåˆ™ï¼ˆåŸºäº Dify æ¶æ„åˆ†æï¼‰â­

| åŸåˆ™ | è¯´æ˜ | å‚è€ƒæ¥æº |
|-----|------|---------|
| **1. Variable å’Œ Event æ˜¯é¢†åŸŸæ¦‚å¿µ** | ä¸è¦ä½œä¸ºåŸºç¡€è®¾æ–½ç»„ä»¶ï¼Œè€Œæ˜¯ä½œä¸ºå€¼å¯¹è±¡åœ¨é¢†åŸŸå±‚å®šä¹‰ | Dify VariablePool |
| **2. VariablePool ä½œä¸ºé¢†åŸŸæœåŠ¡** | ç®¡ç†å˜é‡ç”Ÿå‘½å‘¨æœŸï¼Œæä¾›ç»Ÿä¸€è®¿é—®æ¥å£ï¼ˆé€‰æ‹©å™¨æ¨¡å¼ï¼‰ | Dify GraphRuntimeState |
| **3. èšåˆæ ¹æŒæœ‰å…±äº«çŠ¶æ€** | PipelineExecution æŒæœ‰ VariablePool å’Œ EventHistory | Dify GraphRuntimeState |
| **4. äº‹ä»¶é©±åŠ¨æ‰§è¡Œæµ** | èŠ‚ç‚¹æ‰§è¡Œ â†’ å‘äº‹ä»¶ â†’ EventHandler å¤„ç† â†’ æ›´æ–°çŠ¶æ€ â†’ è§¦å‘ä¸‹ä¸€èŠ‚ç‚¹ | Dify EventHandler |
| **5. åªè¯»è§†å›¾ä¿æŠ¤æ•°æ®** | å¯¹å¤–æš´éœ² ReadOnlyVariablePoolï¼Œé˜²æ­¢æ„å¤–ä¿®æ”¹ | Dify ReadOnlyWrapper |
| **6. Gateway åˆ†ç¦»å…³æ³¨ç‚¹** | é¢†åŸŸå±‚å®šä¹‰æ¥å£ï¼ŒåŸºç¡€è®¾æ–½å±‚å®ç°ï¼Œå¯éšæ—¶æ›¿æ¢ | COLA Gateway |
| **7. ExecutionOrchestrator æ˜¯é¢†åŸŸæœåŠ¡** | åŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆè§¦å‘è¯„ä¼°ã€ä¾èµ–è§£æï¼‰ï¼Œä¸æ˜¯åº”ç”¨æœåŠ¡ | Dify GraphEngine |
| **8. Application å±‚ä¿æŒè–„å±‚** | åªåšç”¨ä¾‹ç¼–æ’ã€äº‹åŠ¡ç®¡ç†ã€æƒé™æ§åˆ¶ã€DTO è½¬æ¢ | COLA Application |

### 2.2 å®ç°æ¸…å•

**é¢†åŸŸå±‚å®ç°ï¼š**

- [ ] å®šä¹‰ Variableã€Event å€¼å¯¹è±¡
- [ ] å®ç° VariablePool é¢†åŸŸæœåŠ¡ï¼ˆæ”¯æŒé€‰æ‹©å™¨æ¨¡å¼ã€åµŒå¥—è®¿é—®ï¼‰
- [ ] å®ç° EventSubscriptionManager é¢†åŸŸæœåŠ¡
- [ ] å®ç° ExecutionOrchestrator é¢†åŸŸæœåŠ¡
- [ ] PipelineExecution èšåˆæ ¹æŒæœ‰ VariablePool å’Œ EventHistory
- [ ] å®šä¹‰ Gateway æ¥å£ï¼ˆVariableStorageGateway, EventPublishGatewayï¼‰
- [ ] å®ç°åªè¯»è§†å›¾ï¼ˆReadOnlyVariablePoolï¼‰

**åŸºç¡€è®¾æ–½å±‚å®ç°ï¼š**

- [ ] å®ç° Gatewayï¼ˆRedis, Kafka, PostgreSQLï¼‰
- [ ] å®ç°äº‹ä»¶å¤„ç†å™¨ï¼ˆEventHandler + å•åˆ†æ´¾æ¨¡å¼ï¼‰
- [ ] å®ç°å¼‚æ­¥äº‹ä»¶é˜Ÿåˆ—å’Œè°ƒåº¦å™¨

**åº”ç”¨å±‚å®ç°ï¼š**

- [ ] å®ç° Application å±‚æœåŠ¡ï¼ˆè–„å±‚ç¼–æ’ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv5.1 (COLA é£æ ¼ + Dify æ¶æ„å®è·µ)

**æœ€åæ›´æ–°**ï¼š2025-12-08

**å‚è€ƒæ¶æ„**ï¼š

- é˜¿é‡Œå·´å·´ COLA v5
- Dify å·¥ä½œæµå¼•æ“æ¶æ„
- å…­è¾¹å½¢æ¶æ„ (Hexagonal Architecture)
- æ•´æ´æ¶æ„ (Clean Architecture)

**ä½œè€…**ï¼šæ¶æ„è®¾è®¡ç»„
